---
title: "CRISPR Lineage Tracing QC"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
library(dplyr)
library(tidyr)
library(magrittr)
library(knitr)
library(kableExtra)
library(readr)
library(stringr)
library(ggplot2)
library(stringr)
library(fastqcr)
source("./src/plot.R")
source("./src/circular.R")
source("./src/sequence_to_character.R")
``` 

## Data
Randomly sampled 5000 reads from Church's data.

## Plot construct
```{r construct}
ref <- read_delim("./test_data/ref.txt",delim=" ")
plot_construct(ref)
```

## FastQC {.tabset}
```{r QC}
qc_dir <- "./fastqc_out"
fastqc("./test_data",qc.dir=qc_dir)
```

### Per base quality
``` {r}
qc <- qc_read("./fastqc_out/example_fastqc.zip")
qc_plot(qc, "Per base sequence quality")
```

### Per sequence quality
``` {r}
qc_plot(qc, "Per sequence quality scores")
```

### Sequence length distribution
``` {r}
qc_plot(qc, "Per base N content")
```

## Alignment
``` {r align}
start_time <- Sys.time()
system("python ./src/alignment.py --input ./test_data/example.fastq --reference ./test_data/ref.txt --output ./aligned.txt")
end_time <- Sys.time()
paste("Aligning 5000 reads in", round(end_time - start_time,2))
```

## Output file
``` {r out}
aligned_barcode <- read_tsv("./aligned.txt") %>%
  mutate(id=1:n())
print(nrow(aligned_barcode))
kable(head(aligned_barcode) %>% select(id,count,score,spacer)) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

## Score distribution
``` {r score}
ggplot(aligned_barcode) + 
  geom_histogram(aes(x=score,y=..density..),binwidth=5) +
  ylab("percentage") +
  theme_classic()
```

## Lorenz curve
``` {r lorenz}
lorenz_curve(aligned_barcode)
```

## Sequence to character
``` {r s2c}
start_time <- Sys.time()
mutation_df <- seq_to_character(aligned_barcode) %>%
  mutate(id=1:n())
kable(head(mutation_df) %>% select(id,count,type,start,length))
end_time <- Sys.time()
paste("It takes",end_time-start_time)
```

## Number of mutations per barcode
``` {r}
num_mutation_histogram(mutation_df)
```

## Mutation types
``` {r,message=FALSE}
mutation_type(mutation_df) 
```

## Mutation Hotspot {.tabset}

### Deletions
``` {r}
deletions <- mutation_df %>%
  filter(type=="deletion") %>%
  group_by(start,length) %>%
  summarise(count=sum(count)) %>%
  mutate(end=start+length) %>%
  ungroup %>%
  mutate(id=1:n()) %>%
  mutate(log10_count=log10(count))
circular_chordgram(df=deletions,title="deletions",ref)
```

### Insertions
``` {r}
insertions <- mutation_df %>%
  filter(type=="insertion") %>%
  group_by(start,length) %>%
  summarise(count=sum(count)) %>%
  mutate(end=start+length) %>%
  ungroup %>%
  mutate(id=1:n()) %>%
  mutate(log10_count=log10(count))

circular_chordgram(df=insertions,title="insertions",ref)
```

### Mutations
``` {r}
mutations <- filter(mutation_df,type=="mutation") %>%
  group_by(start,length,mutate_to) %>%
  summarise(count=sum(count)) %>%
  ungroup

circular_histogram(mutations,ref)
```
